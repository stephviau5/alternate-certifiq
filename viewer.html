<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CertifiQ Certificate Viewer</title>
  <meta name="description" content="Verifiable collectible record powered by CertifiQ." />

  <!-- ethers.js for on-chain ownerOf() -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#000; --panel:#0f0f10; --border:#2a2a2f; --text:#fff; --muted:#9ca3af; --accent:#a855f7;
      --radius-xl:1rem; --radius-lg:.5rem;
      --font:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Ubuntu,Cantarell,"Noto Sans",Helvetica,Arial,sans-serif;
      --link:#fbbf24; /* warm yellow for links in kv area */
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:radial-gradient(circle at 20% 20%,rgba(168,85,247,.15) 0%,rgba(0,0,0,0) 60%),var(--bg);
      color:var(--text); font-family:var(--font); display:flex; justify-content:center; align-items:flex-start; padding:2rem 1rem 4rem;
    }
    .wrap{
      width:100%; max-width:1000px; display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;
      background:var(--panel); border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:0 30px 80px rgba(0,0,0,.9); padding:1.5rem;
    }
    @media(max-width:820px){ .wrap{grid-template-columns:1fr; max-width:480px;} }

    a.backLink{ display:inline-block; font-size:.9rem; margin:0 0 1rem; color:#fbbf24; text-decoration:none; font-weight:600 }
    a.backLink:hover{ text-decoration:underline }

    /* LEFT media */
    .mediaCard{
      aspect-ratio: 1 / 1; /* perfect square */
      overflow:hidden; background:#000; border:1px solid var(--border); border-radius:var(--radius-lg); padding:0;
      display:flex; align-items:center; justify-content:center;
    }
    .mediaCard img{
      width:100%; height:100%; object-fit:cover; display:block; border-radius:inherit;
    }

    /* RIGHT meta */
    h1{ font-size:1.6rem; margin:.25rem 0 .25rem 0; line-height:1.2 }
    .badge{ background:#fbbf24; color:#111; font-size:.75rem; font-weight:700; border-radius:999px; padding:.25rem .5rem; margin-left:.5rem; }
    .kv{ font-size:.95rem; line-height:1.5; color:#d1d5db; margin:.5rem 0 .75rem; }
    .kv strong{ color:#fff }
    .kv a{ color:var(--link); text-underline-offset:2px }

    .desc{ margin:.25rem 0 1rem; color:#d1d5db; font-size:.95rem; line-height:1.55 }
    .desc a{ color:var(--accent); text-decoration:none }
    .desc a:hover{ text-decoration:underline }

    .sectionTitle{ font-size:.8rem; font-weight:700; color:#fff; margin:1rem 0 .5rem; text-transform:uppercase; letter-spacing:.06em }
    .detailsTable{ width:100%; border-collapse:collapse; font-size:.9rem; }
    .detailsTable tr{ border-bottom:1px solid var(--border) }
    .detailsTable td{ padding:.55rem .25rem; vertical-align:top }
    .detailsTable td.label{ color:var(--muted); width:38%; font-weight:600 }
    .detailsTable td.value{ color:#fff; font-weight:600; word-break:break-word }
    .errorBox{ display:none; max-width:360px; background:#1a1a1a; border:1px solid #5a1a1a; border-radius:var(--radius-lg); color:#fff; padding:1rem; margin-top:1rem; text-align:center }
    .errorBox h2{ margin:0 0 .5rem; color:#ff8080; font-size:.95rem }

    footer{ grid-column:1 / -1; text-align:center; color:var(--muted); font-size:.8rem; margin-top:1rem }

    /* Report panel */
    .report-panel{ margin:.75rem 0 1rem; padding:.75rem; border:1px solid var(--border); border-radius:var(--radius-lg); background:#0b0b0d; display:none }
    .report-grid{ display:grid; grid-template-columns:40% 60%; gap:.35rem .75rem; font-size:.9rem }
    .report-grid .label{ color:var(--muted) }
    .report-grid .value{ color:#fff; font-weight:600; word-break:break-word }
    .report-sublist{ margin:.25rem 0 0; padding-left:1rem; font-weight:600 }
    .report-muted{ color:var(--muted); font-size:.8rem; margin-top:.5rem }
  </style>
</head>
<body>
  <div class="wrap" id="viewer">
    <div style="grid-column:1 / -1;">
      <a class="backLink" href="index.html">← New lookup</a>
    </div>

    <!-- LEFT -->
    <div class="mediaCard">
      <img id="cardImage" alt="Collectible image" />
    </div>

    <!-- RIGHT -->
    <div class="metaBlock">
      <h1>
        <span id="itemTitle">Loading…</span>
        <span class="badge" id="gradeBadge"></span>
      </h1>

      <div id="itemDesc" class="desc" style="display:none;"></div>

      <div class="kv">
        <div><strong>Grader:</strong> <span id="graderVal">—</span></div>
        <div><strong>Cert #:</strong> <span id="certVal">—</span></div>
        <div><strong>Chain / Proof:</strong> <span id="chainProof">—</span></div>
        <div><strong>Owner:</strong> <span id="ownerVal">—</span></div>
      </div>

      <!-- Report Details (auto-filled when report_url present) -->
      <div id="reportPanel" class="report-panel">
        <div class="sectionTitle">Report Details</div>
        <div id="reportDetails"></div>
        <div class="report-muted">Pulled from report.json</div>
      </div>

      <div class="sectionTitle">Details</div>
      <table class="detailsTable">
        <tr><td class="label">Card / Item</td><td class="value" id="itemName">—</td></tr>
        <tr><td class="label">Set / Series</td><td class="value" id="itemSet">—</td></tr>
        <tr><td class="label">Year</td><td class="value" id="itemYear">—</td></tr>
        <tr><td class="label">Attributes</td><td class="value" id="itemAttrs">—</td></tr>
        <tr><td class="label">Last Verified</td><td class="value" id="lastVerified">—</td></tr>
        <tr><td class="label">External Link</td><td class="value" id="externalLink">—</td></tr>
        <tr><td class="label">Report</td><td class="value" id="reportLink">—</td></tr>
        <tr><td class="label">Pointer Files</td><td class="value" id="pointerLinks">—</td></tr>
      </table>

      <div id="errorArea" class="errorBox">
        <h2>Record Not Found</h2>
        <p>We couldn’t load metadata for this cert. It may be new, renamed, or not mirrored yet.</p>
      </div>
    </div>

    <footer>© <span id="year"></span> CertifiQ Collectibles</footer>
  </div>

  <script>
    /* ------------------ DOM & helpers ------------------ */
    function getParam(name){ return new URL(window.location.href).searchParams.get(name); }
    document.getElementById('year').textContent = new Date().getFullYear();

    // DOM refs
    const imgEl = document.getElementById('cardImage');
    const itemTitleEl = document.getElementById('itemTitle');
    const itemDescEl  = document.getElementById('itemDesc');
    const gradeBadgeEl = document.getElementById('gradeBadge');
    const graderValEl = document.getElementById('graderVal');
    const certValEl = document.getElementById('certVal');
    const chainProofEl = document.getElementById('chainProof');
    const ownerValEl = document.getElementById('ownerVal');
    const itemNameEl = document.getElementById('itemName');
    const itemSetEl = document.getElementById('itemSet');
    const itemYearEl = document.getElementById('itemYear');
    const itemAttrsEl = document.getElementById('itemAttrs');
    const externalLinkEl = document.getElementById('externalLink');
    const reportLinkEl = document.getElementById('reportLink');
    const pointerLinksEl = document.getElementById('pointerLinks');
    const lastVerifiedEl = document.getElementById('lastVerified');
    const reportPanelEl = document.getElementById('reportPanel');
    const reportDetailsEl = document.getElementById('reportDetails');
    const errBox = document.getElementById('errorArea');

    // URL params
    const grader = (getParam('grader') || '').toLowerCase();
    const certId = getParam('id');
    graderValEl.textContent = grader || '—';
    certValEl.textContent   = certId || '—';

    function showError(){ errBox.style.display='block'; }

    function getAttr(meta, traitName){
      if (!Array.isArray(meta.attributes)) return undefined;
      const found = meta.attributes.find(a => a && a.trait_type === traitName);
      return found ? found.value : undefined;
    }

    /* ------------------ main load ------------------ */
    async function loadMetadata(){
      if(!grader || !certId){ showError(); return; }
      const localUrl = `data/${encodeURIComponent(grader)}/${encodeURIComponent(certId)}.json`;
      let meta;
      try{
        const res = await fetch(localUrl, {cache:'no-store'});
        if(!res.ok) throw new Error('meta fetch failed');
        meta = await res.json();
      }catch(e){ console.warn(e); showError(); return; }

      render(meta);

      // After render: fetch report if present, then owner on-chain
      if (meta.report_url) { fetchAndRenderReport(meta.report_url); }
      fetchOwner("0x702d27AF329c56FE91ef2e09Bf445f86f7Ab8846", certId);
    }

    /* ------------------ render meta ------------------ */
    function render(meta){
      const nameVal       = meta.name || '—';
      const descVal       = meta.description || '';
      const imgUrl        = meta.image || '';
      const cardVal       = getAttr(meta,'Card') || '—';
      const setVal        = getAttr(meta,'Set') || '—';
      const variantVal    = getAttr(meta,'Variant');
      const numberVal     = getAttr(meta,'Number');
      const graderText    = getAttr(meta,'Grader') || grader || '—';
      const certNumText   = getAttr(meta,'Certification Number') || certId || '—';
      const officialGrade = getAttr(meta,'Official Grade') || 'UNVERIFIED';
      const scoreVal      = getAttr(meta,'CertifIQ Score');
      const versionVal    = getAttr(meta,'Version');

      let yearGuess='—'; if (setVal){ const m=setVal.match(/\b(19|20)\d{2}\b/); if(m) yearGuess=m[0]; }
      const extras=[]; if(variantVal) extras.push(`${variantVal}`); if(numberVal) extras.push(`#${numberVal}`); if(scoreVal) extras.push(`Score ${scoreVal}/100`); if(versionVal) extras.push(versionVal);
      const extrasDisplay = extras.length?extras.join(', '):'—';

      const externalUrl = meta.external_url || '';
      const reportUrl   = meta.report_url   || '';
      const lastVerifiedText = '—';

      // header
      itemTitleEl.textContent = nameVal;
      gradeBadgeEl.textContent = officialGrade;

      // description (with URLs auto-linked, line-breaks preserved)
      if (descVal && String(descVal).trim()){
        const linked = String(descVal).replace(/(https?:\/\/[^\s)]+)\)?/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');
        const html = linked.split(/\n{2,}/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('');
        itemDescEl.innerHTML = html;
        itemDescEl.style.display = '';
      } else {
        itemDescEl.style.display = 'none';
      }

      // image
      imgEl.src = imgUrl; imgEl.alt = nameVal || 'Collectible image';

      // kv
      graderValEl.textContent = graderText;
      certValEl.textContent   = certNumText;

      // chain link
      const CONTRACT_ADDR = '0x702d27AF329c56FE91ef2e09Bf445f86f7Ab8846';
      const shortContract = CONTRACT_ADDR.slice(0,6)+'...'+CONTRACT_ADDR.slice(-4);
      const polygonUrl = certId
        ? `https://polygonscan.com/token/${CONTRACT_ADDR}?a=${encodeURIComponent(certId)}`
        : `https://polygonscan.com/token/${CONTRACT_ADDR}`;
      chainProofEl.innerHTML = `<a href="${polygonUrl}" target="_blank" rel="noopener">${shortContract}</a>`;

      // details table
      itemNameEl.textContent  = cardVal || '—';
      itemSetEl.textContent   = setVal || '—';
      itemYearEl.textContent  = yearGuess || '—';
      itemAttrsEl.textContent = extrasDisplay;
      lastVerifiedEl.textContent = lastVerifiedText;

      externalLinkEl.innerHTML = externalUrl ? `<a href="${externalUrl}" target="_blank" rel="noopener">Open in CertifiQ</a>` : '—';
      reportLinkEl.innerHTML   = reportUrl   ? `<a href="${reportUrl}" target="_blank" rel="noopener">View Report JSON</a>` : '—';

      // Pointer links via meta.pointer + meta.logs (ipfs:// → https gateway)
      let pointerRoot = '';
      let logsHttpUrl = '';
      if (meta.pointer){
        let ptr = meta.pointer.replace(/^ipfs:\/\//i,'https://chocolate-added-bovid-122.mypinata.cloud/ipfs/');
        ptr = ptr.replace(/\/index\.json$/i,''); // folder root
        pointerRoot = ptr;
      }
      if (meta.logs){
        logsHttpUrl = meta.logs.replace(/^ipfs:\/\//i,'https://chocolate-added-bovid-122.mypinata.cloud/ipfs/');
      }
      if (pointerRoot){
        const indexUrl = pointerRoot + '/index.json';
        const galleryUrl = pointerRoot + '/gallery';
        const groupUrl = pointerRoot + '/';
        let links = `<a href="${groupUrl}" target="_blank" rel="noopener">Group Folder</a> | <a href="${indexUrl}" target="_blank" rel="noopener">Index</a> | <a href="${galleryUrl}" target="_blank" rel="noopener">Gallery</a>`;
        if (logsHttpUrl) links += ` | <a href="${logsHttpUrl}" target="_blank" rel="noopener">Logs</a>`;
        pointerLinksEl.innerHTML = links;
      } else {
        pointerLinksEl.textContent = '—';
      }
    }

    /* ------------------ report fetch/render ------------------ */
    async function fetchAndRenderReport(url){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('report fetch failed');
        const report = await res.json();
        renderReport(report);
      }catch(e){
        reportPanelEl.style.display='none';
      }
    }

    function renderReport(r){
      const pick = (...paths)=>{ for(const p of paths){ const v=getPath(r,p); if(v!==undefined && v!==null && String(v).trim!=='') return v; } };
      const rows = [];
      const add = (label, value)=>{
        if(value===undefined || value===null || value==='') return;
        if(Array.isArray(value)){
          rows.push([label, `<ul class="report-sublist">${value.map(v=>`<li>${escapeHtml(formatVal(v))}</li>`).join('')}</ul>`]);
        }else if(typeof value==='object'){
          const list = Object.entries(value).map(([k,v])=>`<div>${escapeHtml(k)}: <strong>${escapeHtml(formatVal(v))}</strong></div>`).join('');
          rows.push([label, list]);
        }else{
          rows.push([label, escapeHtml(String(value))]);
        }
      };

      const title     = pick(['title'],['name'],['card','title'],['metadata','name']);
      const score     = pick(['score'],['certifiqScore'],['grades','overall'],['grading','score']);
      const subgrades = pick(['subgrades'],['grades','sub'],['grading','subgrades']);
      const grader    = pick(['grader'],['grading','grader'],['attributes','Grader']);
      const gradedAt  = pick(['gradedAt'],['timestamp'],['grading','date']);
      const serial    = pick(['serial'],['cert'],['certificate'],['attributes','Certification Number']);
      const variant   = pick(['variant'],['attributes','Variant']);
      const number    = pick(['number'],['attributes','Number']);
      const dims      = pick(['dimensions'],['size']);
      const notes     = pick(['notes'],['comments'],['grading','notes']);
      const extras    = pick(['extras'],['additional']);

      add('Title', title);
      add('Score', score);
      add('Subgrades', subgrades);
      add('Grader', grader);
      add('Graded At', formatDate(gradedAt));
      add('Certificate #', serial);
      add('Variant / No.', [variant,number].filter(Boolean).join(' • ') || undefined);
      add('Dimensions', dims);
      add('Notes', notes);
      if (extras) add('Extras', extras);

      if (rows.length===0){
        // fallback: show a few top-level scalars so panel isn't empty
        const scalars = Object.entries(r).filter(([,v])=>['string','number','boolean'].includes(typeof v)).slice(0,10);
        if (scalars.length){
          scalars.forEach(([k,v])=>add(k,v));
        } else {
          reportPanelEl.style.display='none';
          return;
        }
      }

      reportDetailsEl.innerHTML = `
        <div class="report-grid">
          ${rows.map(([label,val])=>`<div class="label">${label}</div><div class="value">${val}</div>`).join('')}
        </div>
      `;
      reportPanelEl.style.display='';
    }

    // tiny utils for report rendering
    function getPath(obj, pathArr){
      try{ let cur=obj; for(const key of pathArr){ if(cur==null) return; cur=cur[key]; } return cur; }catch{ return; }
    }
    function formatDate(d){ if(!d) return; const dt=new Date(d); return isNaN(dt)? String(d): dt.toLocaleString(); }
    function formatVal(v){ if(v==null) return ''; if(typeof v==='object') return JSON.stringify(v); return String(v); }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    /* ------------------ on-chain owner ------------------ */
    async function fetchOwner(contractAddr, tokenId){
      const cell = ownerValEl;
      try{
        const provider = new ethers.providers.JsonRpcProvider("https://polygon-rpc.com");
        const abi = ["function ownerOf(uint256 tokenId) view returns (address)"];
        const contract = new ethers.Contract(contractAddr, abi, provider);
        const wallet = await contract.ownerOf(tokenId);
        const short = wallet.slice(0,6)+'...'+wallet.slice(-4);
        cell.innerHTML = `<a href="https://polygonscan.com/address/${wallet}" target="_blank" rel="noopener">${short}</a>`;
      }catch(err){
        console.warn('ownerOf failed', err);
        cell.textContent = (err && err.code === "CALL_EXCEPTION") ? "Not minted yet" : "Error fetching owner";
      }
    }

    // kick off
    loadMetadata();
  </script>
</body>
</html>
