<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CertifiQ Certificate Viewer</title>
  <meta name="description" content="Verifiable collectible record powered by CertifiQ." />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg:#000;
      --panel:#0f0f10;
      --border:#2a2a2f;
      --text-main:#fff;
      --text-dim:#9ca3af;
      --accent:#fbb51a;
      --radius-xl:1rem;
      --radius-lg:.5rem;
      --font:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Ubuntu,Cantarell,"Noto Sans",Helvetica,Arial,sans-serif;
    }
    body{
      margin:0;
      min-height:100vh;
      background:radial-gradient(circle at 20% 20%,rgba(168,85,247,.15) 0%,rgba(0,0,0,0) 60%),var(--bg);
      color:var(--text-main);
      font-family:var(--font);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:2rem 1rem 4rem;
    }
    .wrap{
      width:100%;
      max-width:900px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1.5rem;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius-xl);
      box-shadow:0 30px 80px rgba(0,0,0,.9);
      padding:1.5rem;
    }
    @media(max-width:700px){
      .wrap{
        grid-template-columns:1fr;
        max-width:420px;
      }
    }
    .mediaCard{
      background:#000;
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:1rem;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
    }
    .mediaCard img{
      width:100%;
      height:auto;
      max-width:320px;
      border-radius:.5rem;
      border:1px solid #333;
      box-shadow:0 20px 60px rgba(0,0,0,.8);
      background:#111;
      object-fit:contain;
    }
    .metaBlock h1{
      font-size:1rem;
      font-weight:600;
      margin:0 0 .5rem;
      display:flex;
      flex-wrap:wrap;
      align-items:baseline;
      gap:.5rem;
    }
    .badge{
      background:var(--accent);
      color:#fff;
      font-size:.7rem;
      line-height:1.2;
      font-weight:600;
      border-radius:999px;
      padding:.3rem .5rem;
    }
    .kv{
      font-size:.8rem;
      line-height:1.4;
      margin:0 0 1rem;
      color:var(--text-dim);
    }
    .kv strong{ color:var(--text-main); font-weight:600; }
    .sectionTitle{
      font-size:.75rem;
      font-weight:600;
      color:var(--text-main);
      margin:1rem 0 .4rem;
      text-transform:uppercase;
      letter-spacing:.05em;
    }
    .detailsTable{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
      line-height:1.4;
    }
    .detailsTable tr{ border-bottom:1px solid var(--border); }
    .detailsTable td{ padding:.5rem .25rem; vertical-align:top; }
    .detailsTable td.label{ color:var(--text-dim); width:35%; font-weight:500; }
    .detailsTable td.value{ color:var(--text-main); font-weight:600; word-break:break-word; }
    .errorBox{
      max-width:360px;
      background:#1a1a1a;
      border:1px solid #5a1a1a;
      border-radius:var(--radius-lg);
      color:#fff;
      padding:1rem;
      margin-top:2rem;
      text-align:center;
    }
    .errorBox h2{ margin:0 0 .5rem; color:#ff8080; font-size:.9rem; font-weight:600; }
    footer{
      font-size:.7rem;
      color:var(--text-dim);
      text-align:center;
      margin-top:1.5rem;
      grid-column:1 / -1;
    }
    a{color:var(--accent);}

    a.backLink{
      display:inline-block;
      font-size:.75rem;
      margin-bottom:1rem;
      color:var(--accent);
      text-decoration:none;
      font-weight:500;
    }

    .mediaCard {
  aspect-ratio: 1 / 1;
  overflow: hidden;
}
.mediaCard img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
h1.mainTitle{
  text-align: center;
}
.desc{
  margin:.5rem 0 1rem;
  color:#d1d5db;        /* soft gray */
  font-size:.9rem;
  line-height:1.5;
}
.desc a{ color:#a855f7; text-decoration:none; }
.desc a:hover{ text-decoration:underline; }

.report-panel{
  margin: .75rem 0 1rem;
  padding: .75rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  background: #0b0b0d;
}
.report-grid{
  display: grid;
  grid-template-columns: 40% 60%;
  gap: .35rem .75rem;
  font-size: .85rem;
}
.report-grid .label{
  color: var(--text-dim);
}
.report-grid .value{
  color: var(--text-main);
  font-weight: 600;
  word-break: break-word;
}
.report-sublist{
  margin: .25rem 0 0;
  padding-left: 1rem;
  font-weight: 600;
}
.report-muted{
  color: var(--text-dim);
  font-size: .8rem;
}


  </style>
</head>
<body>
  <div class="wrap" id="viewer">
    <div style="grid-column:1 / -1;">
      <a class="backLink" href="index.html">← New lookup</a>
      <h1 class="mainTitle">Alternate CertifiQ Ownership & NFT Lookup</h1>
    </div>

    <div class="mediaCard">
      <img id="cardImage" alt="Collectible image" />
    </div>

    <div class="metaBlock">
      <h1>
        <span id="itemTitle">Loading…</span>
        <span class="badge" id="gradeBadge"></span>
      </h1>
      <div id="itemDesc" class="desc"></div>

      <div class="kv">
        <div><strong>Grader:</strong> <span id="graderVal"></span></div>
        <div><strong>Cert #:</strong> <span id="certVal"></span></div>
        <div><strong>Chain / Proof:</strong> <span id="chainProof"></span></div>
        <div id="ownerSection"><strong>Owner:</strong> <span id="ownerVal">Loading…</span></div>      
      </div>
    </div>

    <div class="mediaDetails">
      <div class="sectionTitle">Details</div>
      <table class="detailsTable">
        <tr><td class="label">Card / Item</td><td class="value" id="itemName">—</td></tr>
        <tr><td class="label">Set / Series</td><td class="value" id="itemSet">—</td></tr>
        <tr><td class="label">Year</td><td class="value" id="itemYear">—</td></tr>
        <tr><td class="label">Attributes</td><td class="value" id="itemAttrs">—</td></tr>
        <tr><td class="label">Last Verified</td><td class="value" id="lastVerified">—</td></tr>
        <tr><td class="label">External Link</td><td class="value" id="externalLink">—</td></tr>
        <tr><td class="label">Report</td><td class="value" id="reportLink">—</td></tr>
        <tr><td class="label">Pointer Files</td><td class="value" id="pointerLinks">—</td></tr>
      </table>
      <div id="errorArea" style="display:none;" class="errorBox">
        <h2>Record Not Found</h2>
        <p>We couldn’t load metadata for this cert. It may be new, renamed,
        or not mirrored yet.<br/><br/>Please contact CertifiQ support.</p>
      </div>
    </div>
    <div id="reportPanel" class="report-panel" style="display:none;">
  <div class="sectionTitle">Report Details</div>
  <div id="reportDetails"></div>
</div>

    <footer>© <span id="year"></span> CertifiQ Collectibles</footer>
  </div>

<script>
  function getParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  // DOM refs
  const imgEl            = document.getElementById('cardImage');
  const itemTitleEl      = document.getElementById('itemTitle');
  const gradeBadgeEl     = document.getElementById('gradeBadge');
  const graderValEl      = document.getElementById('graderVal');
  const certValEl        = document.getElementById('certVal');
  const chainProofEl     = document.getElementById('chainProof');
  const ownerValEl       = document.getElementById('ownerVal');
  const itemNameEl       = document.getElementById('itemName');
  const itemSetEl        = document.getElementById('itemSet');
  const itemYearEl       = document.getElementById('itemYear');
  const itemAttrsEl      = document.getElementById('itemAttrs');
  const externalLinkEl   = document.getElementById('externalLink');
  const reportLinkEl     = document.getElementById('reportLink');
  const pointerLinksEl   = document.getElementById('pointerLinks');
  const lastVerifiedEl   = document.getElementById('lastVerified');
  const errBox           = document.getElementById('errorArea');

  document.getElementById('year').textContent = new Date().getFullYear();

  const grader = (getParam('grader') || '').toLowerCase();
  const certId = getParam('id');

  graderValEl.textContent = grader || '—';
  certValEl.textContent   = certId || '—';

  async function loadMetadata() {
    if (!grader || !certId) {
      showError("Missing grader or ID.");
      return;
    }

    const localUrl = `data/${encodeURIComponent(grader)}/${encodeURIComponent(certId)}.json`;

    let meta;
    try {
      const res = await fetch(localUrl, { cache: 'no-store' });
      if (!res.ok) throw new Error("local fetch failed " + res.status);
      meta = await res.json();
    } catch (e) {
      console.warn("Local metadata not found.", e);
      showError("No local metadata.");
      return;
    }

    render(meta);

    fetchOwner("0x702d27AF329c56FE91ef2e09Bf445f86f7Ab8846", certId);
  }
  if (meta.report_url) {
  fetchAndRenderReport(meta.report_url);
}


  function showError() {
    errBox.style.display = 'block';
  }

  function getAttr(meta, traitName){
    if (!Array.isArray(meta.attributes)) return undefined;
    const found = meta.attributes.find(a => a && a.trait_type === traitName);
    return found ? found.value : undefined;
  }

  function render(meta){
    const nameVal        = meta.name || '—';
    const imgUrl         = meta.image || '';

    const cardVal        = getAttr(meta, 'Card') || '—';
    const setVal         = getAttr(meta, 'Set') || '—';
    const variantVal     = getAttr(meta, 'Variant');
    const numberVal      = getAttr(meta, 'Number');
    const graderText     = getAttr(meta, 'Grader') || grader || '—';
    const certNumText    = getAttr(meta, 'Certification Number') || certId || '—';
    const officialGrade  = getAttr(meta, 'Official Grade') || 'UNVERIFIED';
    const scoreVal       = getAttr(meta, 'CertifIQ Score');
    const versionVal     = getAttr(meta, 'Version');
    const itemDescEl = document.getElementById('itemDesc');
    const reportPanelEl   = document.getElementById('reportPanel');
const reportDetailsEl = document.getElementById('reportDetails');


    let yearGuess = '—';
    if (setVal) {
      const m = setVal.match(/\b(19|20)\d{2}\b/);
      if (m) yearGuess = m[0];
    }

    const extras = [];
    if (variantVal) extras.push(`${variantVal}`);
    if (numberVal)  extras.push(`#${numberVal}`);
    if (scoreVal)   extras.push(`Score ${scoreVal}/100`);
    if (versionVal) extras.push(versionVal);
    const extrasDisplay = extras.length ? extras.join(', ') : '—';

    const externalUrl = meta.external_url || '';
    const reportUrl   = meta.report_url   || '';
    const lastVerifiedText = '—';

    const CONTRACT_ADDR = '0x702d27AF329c56FE91ef2e09Bf445f86f7Ab8846';
    const shortContract = CONTRACT_ADDR.slice(0, 6) + '...' + CONTRACT_ADDR.slice(-4);
    const polygonUrl = certId
      ? `https://polygonscan.com/token/${CONTRACT_ADDR}?a=${encodeURIComponent(certId)}`
      : `https://polygonscan.com/token/${CONTRACT_ADDR}`;

    // ---- Pointer Files (dynamic)
    let pointerRoot = "";
    let logsHttpUrl = "";

    if (meta.pointer) {
      let ptrHttp = meta.pointer.replace(
        /^ipfs:\/\//i,
        "https://chocolate-added-bovid-122.mypinata.cloud/ipfs/"
      );
      ptrHttp = ptrHttp.replace(/\/index\.json$/i, "");
      pointerRoot = ptrHttp;
    }

    if (meta.logs) {
      logsHttpUrl = meta.logs.replace(
        /^ipfs:\/\//i,
        "https://chocolate-added-bovid-122.mypinata.cloud/ipfs/"
      );
    }

    if (pointerRoot) {
      const indexUrl   = pointerRoot + "/index.json";
      const galleryUrl = pointerRoot + "/gallery";
      const groupUrl   = pointerRoot + "/";

      let linksHtml = `
        <a href="${groupUrl}" target="_blank" rel="noopener">Group Folder</a> |
        <a href="${indexUrl}" target="_blank" rel="noopener">Index</a> |
        <a href="${galleryUrl}" target="_blank" rel="noopener">Gallery</a>
      `;
      if (logsHttpUrl) {
        linksHtml += ` | <a href="${logsHttpUrl}" target="_blank" rel="noopener">Logs</a>`;
      }
      pointerLinksEl.innerHTML = linksHtml;
    } else {
      pointerLinksEl.textContent = '—';
    }

    // ---- DOM updates
    itemTitleEl.textContent  = nameVal;
    gradeBadgeEl.textContent = officialGrade;
    imgEl.src = imgUrl;
    imgEl.alt = nameVal || 'Collectible image';

    graderValEl.textContent = graderText;
    certValEl.textContent   = certNumText;

    chainProofEl.innerHTML = `<a href="${polygonUrl}" target="_blank" rel="noopener">${shortContract}</a>`;

    itemNameEl.textContent     = cardVal || '—';
    itemSetEl.textContent      = setVal || '—';
    itemYearEl.textContent     = yearGuess || '—';
    itemAttrsEl.textContent    = extrasDisplay;
    lastVerifiedEl.textContent = lastVerifiedText;

    externalLinkEl.innerHTML = externalUrl
      ? `<a href="${externalUrl}" target="_blank" rel="noopener">Open in CertifiQ</a>`
      : '—';
    reportLinkEl.innerHTML = reportUrl
      ? `<a href="${reportUrl}" target="_blank" rel="noopener">View Report JSON</a>`
      : '—';

      // Description (from JSON: meta.description)
const rawDesc = meta.description || "";
if (rawDesc.trim()) {
  // auto-link URLs
  const linked = rawDesc.replace(/(https?:\/\/[^\s)]+)\)?/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
  // split on blank lines -> paragraphs; single newlines -> <br>
  const html = linked
    .split(/\n{2,}/)                 // paragraphs
    .map(p => `<p>${p.replace(/\n/g, "<br>")}</p>`)
    .join("");
  itemDescEl.innerHTML = html;
  itemDescEl.style.display = "";
} else {
  itemDescEl.style.display = "none";
}

  }

  // ---- New: Fetch Owner from Polygonscan API ----
async function fetchOwner(contractAddr, tokenId) {
  const ownerCell = document.getElementById("ownerVal");
  try {
    // Use public Polygon RPC
    const provider = new ethers.providers.JsonRpcProvider("https://polygon-rpc.com");

    // Standard ERC-721 ABI fragment for ownerOf()
    const abi = ["function ownerOf(uint256 tokenId) view returns (address)"];
    const contract = new ethers.Contract(contractAddr, abi, provider);

    const wallet = await contract.ownerOf(tokenId);

    const short = wallet.slice(0, 6) + "..." + wallet.slice(-4);
    ownerCell.innerHTML = `<a href="https://polygonscan.com/address/${wallet}" target="_blank" rel="noopener">${short}</a>`;
  } catch (err) {
    console.error("Error fetching owner:", err);
    if (err.code === "CALL_EXCEPTION") {
      ownerCell.textContent = "Not minted yet";
    } else {
      ownerCell.textContent = "Error fetching owner";
    }
  }
}
async function fetchAndRenderReport(url){
  try{
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('report fetch failed');
    const report = await res.json();
    renderReport(report);
  }catch(e){
    // hide panel on failure
    reportPanelEl.style.display = 'none';
  }
}

function renderReport(r){
  // Try common fields first (adjusts to your schema), then fallback
  const pick = (...paths) => {
    for(const p of paths){
      const val = getPath(r, p);
      if (val !== undefined && val !== null && String(val).trim() !== '') return val;
    }
    return undefined;
  };

  const title        = pick(['title'], ['name'], ['card','title'], ['metadata','name']);
  const score        = pick(['score'], ['certifiqScore'], ['grades','overall'], ['grading','score']);
  const subgrades    = pick(['subgrades'], ['grades','sub'], ['grading','subgrades']); // array/object
  const graderName   = pick(['grader'], ['grading','grader'], ['attributes','Grader']);
  const gradedAt     = pick(['gradedAt'], ['timestamp'], ['grading','date']);
  const serial       = pick(['serial'], ['cert'], ['certificate'], ['attributes','Certification Number']);
  const variant      = pick(['variant'], ['attributes','Variant']);
  const number       = pick(['number'], ['attributes','Number']);
  const dimensions   = pick(['dimensions'], ['size']);
  const notes        = pick(['notes'], ['comments'], ['grading','notes']);
  const extras       = pick(['extras'], ['additional']);

  const rows = [];
  const pushRow = (label, value) => {
    if (value === undefined || value === null || value === '') return;
    if (Array.isArray(value)) {
      rows.push([label, `<ul class="report-sublist">${value.map(v => `<li>${escapeHtml(formatVal(v))}</li>`).join('')}</ul>`]);
    } else if (typeof value === 'object') {
      // object → key: value list
      const list = Object.entries(value).map(([k,v]) => `<div>${escapeHtml(k)}: <strong>${escapeHtml(formatVal(v))}</strong></div>`).join('');
      rows.push([label, list]);
    } else {
      rows.push([label, escapeHtml(String(value))]);
    }
  };

  pushRow('Title',         title);
  pushRow('Score',         score);
  pushRow('Subgrades',     subgrades);
  pushRow('Grader',        graderName);
  pushRow('Graded At',     formatDate(gradedAt));
  pushRow('Certificate #', serial);
  pushRow('Variant / No.', [variant, number].filter(Boolean).join(' • ') || undefined);
  pushRow('Dimensions',    dimensions);
  pushRow('Notes',         notes);
  if (extras) pushRow('Extras', extras);

  // Fallback: if we got nothing, pretty-print top-level scalars
  if (rows.length === 0){
    const scalars = Object.entries(r)
      .filter(([,v]) => ['string','number','boolean'].includes(typeof v))
      .slice(0, 10);
    if (scalars.length){
      scalars.forEach(([k,v]) => pushRow(k, v));
    } else {
      reportPanelEl.style.display = 'none';
      return;
    }
  }

  reportDetailsEl.innerHTML = `
    <div class="report-grid">
      ${rows.map(([label, value]) => `
        <div class="label">${label}</div>
        <div class="value">${value}</div>
      `).join('')}
    </div>
    <div class="report-muted" style="margin-top:.5rem;">
      Pulled from report.json
    </div>
  `;
  reportPanelEl.style.display = '';
}

// --- small utils ---
function getPath(obj, pathArr){
  try{
    let cur = obj;
    for(const key of pathArr){
      if (cur == null) return undefined;
      if (typeof key === 'string') { cur = cur[key]; continue; }
      return undefined;
    }
    return cur;
  }catch{ return undefined; }
}
function formatDate(d){
  if(!d) return undefined;
  const dt = new Date(d);
  return isNaN(dt) ? String(d) : dt.toLocaleString();
}
function formatVal(v){
  if (v == null) return '';
  if (typeof v === 'object') return JSON.stringify(v);
  return String(v);
}
function escapeHtml(s){
  return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}


  loadMetadata();
</script>

</body>
</html>
